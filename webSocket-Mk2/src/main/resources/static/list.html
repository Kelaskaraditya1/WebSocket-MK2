<!DOCTYPE html>
<html>
<head>
    <title>2. Online User List & Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
        .error { color: red; }
        .success { color: green; }
        #online-users-list {
            list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto;
            border: 1px solid #ccc; margin-top: 10px;
        }
        #online-users-list li { padding: 8px; cursor: pointer; border-bottom: 1px dashed #eee; }
        #online-users-list li:hover { background-color: #e0e0ff; font-weight: bold; }
        #chat-window {
            border: 1px solid #000; padding: 10px; height: 250px; overflow-y: scroll;
            margin-top: 10px; background-color: #fff;
        }
        .sent { text-align: right; color: blue; }
        .received { text-align: left; color: darkgreen; }
    </style>
</head>
<body>

<h2>Welcome, <span id="display-user"></span>!</h2>
<button id="disconnectBtn">Logout</button>

<hr>

<h3>Online Users:</h3>
<ul id="online-users-list">
    <li>Loading users...</li>
</ul>

<hr>

<div id="chat-interface">
    <h3>Chat with: <span id="chat-partner">Select a user to chat</span></h3>

    <div id="chat-window">
    </div>

    <input type="text" id="chatInput" placeholder="Type your message..." style="width: 70%;">
    <button id="sendMsgBtn" disabled>Send</button>
</div>

<script>
    let stompClient = null;
    let currentUsername = sessionStorage.getItem('currentUsername');
    let currentName = sessionStorage.getItem('currentName');
    let activePartnerUsername = null;

    const ENDPOINT = 'http://localhost:8080/chat';
    const USERS_REST_URL = 'http://localhost:8080/get/online/users';
    const HISTORY_API_URL = 'http://localhost:8080/get/chat/messages';

    // --- Disconnect Logic ---
    function disconnect() {
        if (stompClient !== null && stompClient.connected) {
            stompClient.disconnect(function() {
                console.log("STOMP Disconnected.");
            });
        }
        sessionStorage.clear();
        window.location.href = '/index.html';
    }

    // --- Message Display Logic ---
    function displayMessage(sender, content) {
        const chatWindow = document.getElementById('chat-window');
        const messageDiv = document.createElement('div');

        // Only display message if it involves the currently selected partner or is self-sent
        if (sender === currentUsername || sender === activePartnerUsername) {
            if (sender === currentUsername) {
                messageDiv.className = 'sent';
                messageDiv.innerHTML = `<strong>You:</strong> ${content}`;
            } else {
                messageDiv.className = 'received';
                messageDiv.innerHTML = `<strong>${sender}:</strong> ${content}`;
            }
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        } else {
            console.log(`Received message from ${sender}, but ${activePartnerUsername} is selected.`);
        }
    }

    // --- Select User and History Load Logic (CRITICAL) ---
    function selectUser(username, name) {
        activePartnerUsername = username;
        document.getElementById('chat-partner').textContent = `${name} (${username})`;
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendMsgBtn').disabled = false;
        document.getElementById('chatInput').focus();
        document.getElementById('chat-window').innerHTML = '';

        const chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = '<div>Fetching conversation history...</div>';

        const payload = { senderId: currentUsername, receiverId: username };

        // 1. Fetch History via POST
        fetch(HISTORY_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                // If the Java fix for the Optional.get() crash is not implemented,
                // this block will catch the HTTP 500 error.
                throw new Error(`Failed to fetch history. Status: ${response.status}`);
            }
            return response.json();
        })
        .then(responseWrapper => {
            const messages = responseWrapper.chatMessages;

            if (!messages || messages.length === 0) {
                chatWindow.innerHTML = '<div>--- No Conversation Yet. Start the chat! ---</div>';
                return;
            }

            chatWindow.innerHTML = '<div>--- Conversation History ---</div>';
            messages.forEach(msg => {
                displayMessage(msg.senderId, msg.message);
            });
        })
        .catch(error => {
            chatWindow.innerHTML = `<div class="error">Error loading history: ${error.message}. Check Java Safe Optional Handling.</div>`;
            console.error("History Fetch Error:", error);
        });
    }


    // --- User List Display Logic ---
    function displayUserList(users) {
        const userListElement = document.getElementById('online-users-list');
        userListElement.innerHTML = '';

        if (!Array.isArray(users) || users.length === 0) {
            userListElement.innerHTML = '<li>No other users online.</li>';
            return;
        }

        users.forEach(user => {
            if (user.username !== currentUsername) {
                const listItem = document.createElement('li');
                listItem.textContent = `${user.name} (${user.username})`;
                listItem.setAttribute('data-username', user.username);

                // CRITICAL: Attaching the listener correctly here
                listItem.addEventListener('click', () => selectUser(user.username, user.name));

                userListElement.appendChild(listItem);
            }
        });
    }

    // --- WebSocket Connection & Initial Fetch Logic ---
    function initWebSocketSession() {
        const socket = new SockJS(ENDPOINT);
        stompClient = Stomp.over(socket);

        const headers = { 'username': currentUsername };

        stompClient.connect(headers, function (frame) {
            console.log('STOMP CONNECTED successfully.');

            // FIX: This subscription receives live messages from the server,
            // including the self-sent message if the server is configured to send it back.
            stompClient.subscribe('/user/queue/messages', function (message) {
                const messageBody = JSON.parse(message.body);
                // The displayMessage function handles showing the message only if
                // the sender is the active partner or the current user.
                displayMessage(messageBody.senderId, messageBody.message);
            });

        }, function (error) {
            console.error('STOMP CONNECTION ERROR:', error);
        });
    }

    function fetchAndConnect() {
        document.getElementById('display-user').textContent = currentName || 'Guest';

        fetch(USERS_REST_URL)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP Status: ${response.status}`);
                return response.json();
            })
            .then(responseWrapper => {
                const usersArray = responseWrapper.DATA;
                displayUserList(usersArray);

                initWebSocketSession();
            })
            .catch(error => {
                console.error('REST FETCH ERROR:', error);
                document.getElementById('online-users-list').innerHTML = `<li>Error loading users: ${error.message}</li>`;
            });
    }

    function sendMessage() {
        if (!stompClient || !stompClient.connected) {
            alert('Connection lost. Please refresh.');
            return;
        }
        if (!activePartnerUsername) {
            alert('Please select a user to chat with.');
            return;
        }

        const chatInput = document.getElementById('chatInput');
        const content = chatInput.value.trim();
        if (!content) return;

        const chatMessage = {
            senderId: currentUsername,
            receiverId: activePartnerUsername,
            message: content
        };

        // CRITICAL FIX: The correct live messaging destination
        const destination = "/app/chat/send/message";

        stompClient.send(destination, {}, JSON.stringify(chatMessage));

        // --- CRITICAL FIX 2: Immediate Local Echo (Self-Display) ---
        // Display the message immediately on the sender's screen.
        displayMessage(currentUsername, content);
        // -------------------------------------------------------------

        chatInput.value = '';
    }

    // --- Event Listeners and Startup ---

    document.getElementById('disconnectBtn').addEventListener('click', disconnect);
    document.getElementById('sendMsgBtn').addEventListener('click', sendMessage);

    if (currentUsername) {
        fetchAndConnect();
    } else {
        window.location.href = '/index.html';
    }

</script>
</body>
</html>